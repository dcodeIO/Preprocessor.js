/*
 Preprocessor.js (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/Preprocessor.js for details
*/
(function(l){function a(a,c){this.source=""+a;this.baseDir="string"==typeof c?c:".";this.d="object"==typeof c?c:{};this.isNode=("undefined"==typeof window||!window.window)&&"function"==typeof require;this.errorSourceAhead=50;this.c=[]}a.a=/([ ]*)\/\/[ ]+#(include_once|include|ifn?def|if|endif|else|elif|put|define)/g;a.g=/(include_once|include)[ ]+"([^"\\]*(\\.[^"\\]*)*)"[ ]*\r?(?:\n|$)/g;a.f=/(ifdef|ifndef|if)[ ]*([^\r\n]+)\r?\n/g;a.b=/(endif|else|elif)([ ]+[^\r\n]+)?\r?(?:\n|$)/g;a.h=/put[ ]+([^\n]+)[ ]*/g;
a.e=/define[ ]+([^\n]+)\r?(?:\n|$)/g;a.i=/(?:^|[^\\])\*/;a.stripSlashes=function(a){return(a+"").replace(/\\(.?)/g,function(a,b){switch(b){case "\\":return"\\";case "0":return"\x00";case "":return"";default:return b}})};a.addSlashes=function(a){return(a+"").replace(/([\\"'])/g,"\\$1").replace(/\0/g,"\\0")};a.indent=function(a,c){for(var b=a.split("\n"),e=0;e<b.length;e++)b[e]=c+b[e];return b.join("\n")};a.nlToStr=function(a){return"["+a.replace(/\r/g,"").replace(/\n/g,"\\n")+"]"};a.evaluate=function(h,
c,b){"string"===typeof c&&(b=c,c=[]);var e=a.addSlashes;return function(a,b,c){for(var g in a)a.hasOwnProperty(g)&&eval("var "+g+' = "'+e(""+a[g])+'";');for(a=0;a<b.length;a++)g=b[a],"function "!=g.substring(0,9)&&"var "!=g.substring(0,4)&&(g="var "+g),eval(g);return eval(c)}.call(null,h,c,b)};a.prototype.process=function(h,c){h=h||{};c="function"==typeof c?c:function(){};c("Defines: "+JSON.stringify(h));for(var b,e,d,k=[];null!==(b=a.a.exec(this.source));){c(b[2]+" @ "+b.index+"-"+a.a.lastIndex);
var f=b[1];switch(b[2]){case "include_once":case "include":a.g.lastIndex=b.index;if(null===(e=a.g.exec(this.source)))throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");d=a.stripSlashes(e[2]);if("undefined"!==typeof this.d[d])"include_once"===e[1]?(c("  skip incl: "+d),d=""):(c("  incl: "+d),d=this.d[d]);else{if(!this.isNode)throw Error("Failed to resolve include: "+this.baseDir+"/"+d);try{var g=d;if(a.i.test(d)){var l=require("glob");c("  globbing "+
this.baseDir+"/"+d);var m=this;l(this.baseDir+"/"+d,{sync:!0},function(a,b){d="";for(var e=0;e<b.length;e++){c("file",b[e]);var f=require("fs").readFileSync(b[e])+"";m.d[g]=f;d+=f}})}else d=require("fs").readFileSync(this.baseDir+"/"+d)+"",this.d[g]=d}catch(n){throw Error("File not found: "+d+" ("+n+")");}}this.source=this.source.substring(0,b.index)+a.indent(d,f)+this.source.substring(a.g.lastIndex);a.a.lastIndex=0<k.length?k[k.length-1].lastIndex:0;c("  continue at "+a.a.lastIndex);break;case "put":a.h.lastIndex=
b.index;if(null===(e=a.h.exec(this.source)))throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");d=e[1];c("  expr: "+e[1]);d=a.evaluate(h,this.c,e[1]);c("  value: "+a.nlToStr(d));this.source=this.source.substring(0,b.index)+f+d+this.source.substring(a.h.lastIndex);a.a.lastIndex=b.index+d.length;c("  continue at "+a.a.lastIndex);break;case "ifdef":case "ifndef":case "if":a.f.lastIndex=b.index;if(null===(e=a.f.exec(this.source)))throw Error("Illegal #"+
b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");c("  test: "+e[2]);d="ifdef"==e[1]?!!h[e[2]]:"ifndef"==e[1]?!h[e[2]]:a.evaluate(h,this.c,e[2]);c("  value: "+d);k.push(b={include:d,index:b.index,lastIndex:a.f.lastIndex});c("  push: "+JSON.stringify(b));break;case "endif":case "else":case "elif":a.b.lastIndex=b.index;if(null===(e=a.b.exec(this.source)))throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");if(0==k.length)throw Error("Unexpected #"+
e[1]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");f=k.pop();c("  pop: "+JSON.stringify(f));d=this.source.substring(f.lastIndex,b.index);f.include?(c("  incl: "+a.nlToStr(d)+", 0-"+f.index+" + "+d.length+" bytes + "+a.b.lastIndex+"-"+this.source.length),this.source=this.source.substring(0,f.index)+d+this.source.substring(a.b.lastIndex)):(c("  excl: "+a.nlToStr(d)+", 0-"+f.index+" + "+a.b.lastIndex+"-"+this.source.length),d="",this.source=this.source.substring(0,f.index)+
this.source.substring(a.b.lastIndex));""==this.source&&c("  result empty");a.a.lastIndex=f.index+d.length;c("  continue at "+a.a.lastIndex);if("else"==e[1]||"elif"==e[1])d="else"==e[1]?!f.include:a.evaluate(h,this.c,e[2]),k.push(b={include:!f.include,index:a.a.lastIndex,lastIndex:a.a.lastIndex}),c("  push: "+JSON.stringify(b));break;case "define":a.e.lastIndex=b.index;if(null===(e=a.e.exec(this.source)))throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+
"...");var p=e[1];c("  def: "+e[1]);this.c.push(p);this.source=this.source.substring(0,b.index)+f+this.source.substring(a.e.lastIndex);a.a.lastIndex=b.index;c("  continue at "+a.a.lastIndex)}}0<k.length&&(f=k.pop(),c("Still on stack: "+JSON.stringify(f)));return this.source};a.prototype.toString=function(){return"Preprocessor"};"undefined"!=typeof module&&module.exports?module.exports=a:"undefined"!=typeof define&&define.amd?define("Preprocessor",[],function(){return a}):(l.dcodeIO||(l.dcodeIO={}),
l.dcodeIO.Preprocessor=a)})(this);
